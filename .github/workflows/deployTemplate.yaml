name: Deploy Template YAML

on:
  workflow_call:
    inputs:
      subfolder:
        required: false
        type: string
        default: "./"
    secrets:
      KUBE_CONFIG_DATA:
        required: true
jobs:
  check-files:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3.3.0
        with:
          fetch-depth: "0"

      - name: Check .env file existence
        id: check_files
        uses: andstor/file-existence-action@v2.0.0
        with:
          files: ".env"

      - uses: cardinalby/export-env-action@2.1.0
        if: steps.check_files.outputs.files_exists == 'true'
        with:
          envFile: '.env'
          expand: 'true'
          expandWithJobEnv: 'true'
          export: 'true'

      - name: Replace ENV variables
        run: cd ${{ inputs.subfolder }} && mkdir filled && for f in *.yaml; do envsubst < $f > filled/$f ; done

      - name: Debug output filled files
        run: tail -n +1 ${{ inputs.subfolder }}filled/*

      - name: Validate files
        uses: instrumenta/kubeval-action@master
        with:
          strict: true
          files: ${{ inputs.subfolder }}filled/

  apply-to-k8s:
    runs-on: ubuntu-22.04
    needs: check-files
    if: ${{ (((github.event_name == 'push' || github.event_name == 'workflow_dispatch') && github.ref == 'refs/heads/main') || github.event_name == 'schedule') }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3.3.0
        with:
          fetch-depth: "0"

      - name: Check .env file existence
        id: check_files
        uses: andstor/file-existence-action@v2.0.0
        with:
          files: ".env"

      - uses: cardinalby/export-env-action@2.1.0
        if: steps.check_files.outputs.files_exists == 'true'
        with:
          envFile: '.env'
          expand: 'true'
          expandWithJobEnv: 'true'
          export: 'true'

      - name: Replace ENV variables
        run: cd ${{ inputs.subfolder }} && mkdir filled && for f in *.yaml; do envsubst < $f > filled/$f ; done

      - name: Trigger deploy
        uses: Consensys/kubernetes-action@master
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
        with:
          args: apply -f ${{ inputs.subfolder }}filled/