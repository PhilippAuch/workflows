name: Deploy Template YAML

on:
  workflow_call:
    inputs:
      subfolder:
        required: false
        type: string
        default: "./"

jobs:
  check-files:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: "0"

      - uses: cardinalby/export-env-action@v1
        with:
          envFile: '.env'
          expand: 'true'
          expandWithJobEnv: 'true'
          export: 'true'

      - name: Replace ENV variables
        run: for f in $(find ${{ inputs.subfolder }} -regex '.*\.ya*ml'); do envsubst < $f > "${{ inputs.subfolder }}filled/$f"; done

      - name: Debug output filled files
        run: tail -n +1 ${{ inputs.subfolder }}filled/*

      - name: Validate files
        uses: instrumenta/kubeval-action@master
        with:
          strict: true
          files: ${{ inputs.subfolder }}filled/*

      - name: Trigger deploy
        if: false
        uses: Consensys/kubernetes-action@master
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
        with:
          args: apply -f ${{ inputs.subfolder }}filled/*